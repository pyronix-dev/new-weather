module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},52296,e=>{"use strict";var t=e.i(13235);function r(){let e="https://kcwfevcypzgcrvcjgasx.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!r)throw Error("Missing Supabase environment variables");return(0,t.createClient)(e,r,{auth:{autoRefreshToken:!1,persistSession:!1}})}function a(e){if(e){let t=e.split("").reduce((e,t)=>e+t.charCodeAt(0),0);return`MQ${t%9e5+1e5}`}let t=Math.floor(1e5+9e5*Math.random()).toString();return`MQ${t}`}e.s(["createSupabaseAdmin",()=>r,"generateReferenceCode",()=>a])},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},21517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},33405,(e,t,r)=>{t.exports=e.x("child_process",()=>require("child_process"))},95199,e=>{"use strict";var t=e.i(46830),r=e.i(11491),a=e.i(7984),o=e.i(23621),i=e.i(26053),n=e.i(70439),s=e.i(3886),l=e.i(21952),c=e.i(38987),d=e.i(29633),u=e.i(30773),p=e.i(47853),m=e.i(84218),f=e.i(39661),h=e.i(16309),g=e.i(52689),v=e.i(93695);e.i(35077);var b=e.i(38593),x=e.i(32670),_=e.i(23384),w=e.i(75741),R=e.i(52296);let E=new _.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-04-30.basil"}),y=process.env.STRIPE_WEBHOOK_SECRET,S={"sms-monthly":499,"sms-annual":4990,"email-annual":1e3};async function C(t){let r,a=await t.text(),o=t.headers.get("stripe-signature");if(console.log("ðŸ“¥ Received Stripe Webhook"),!o)return console.error("âŒ Missing stripe-signature header"),x.NextResponse.json({error:"Missing stripe-signature header"},{status:400});try{y?(r=E.webhooks.constructEvent(a,o,y),console.log("âœ… Signature verified")):(r=JSON.parse(a),console.warn("âš ï¸ Webhook signature verification skipped (no STRIPE_WEBHOOK_SECRET)"))}catch(e){return console.error("âŒ Webhook signature verification failed:",e),console.log("Expected Secret:",y?`${y.substring(0,10)}...`:"None"),x.NextResponse.json({error:"Webhook signature verification failed"},{status:400})}switch(r.type){case"checkout.session.completed":{let e,t=r.data.object;console.log("âœ… Payment successful!"),console.log("Session ID:",t.id),console.log("Customer email:",t.customer_email),console.log("Metadata:",t.metadata);let a=t.metadata?.plan||"",o=t.metadata?.phone||"",i=t.customer_email||t.metadata?.email||"",n=t.customer_details?.name||"",s=t.customer_details?.address?.country||"MQ",l=t.payment_method_details?.card,c=l?.brand||"",d=l?.last4||"",u="";try{let e,r=(0,R.createSupabaseAdmin)(),{data:l}=await r.from("users").select("id, reference_code").or(`email.eq.${i},phone.eq.${o}`).single();if(l)e=l.id,u=l.reference_code,console.log("ðŸ“¦ Found existing user:",e,"Ref:",u),await r.from("users").update({full_name:n,country:s,stripe_customer_id:t.customer}).eq("id",e);else{u=(0,R.generateReferenceCode)(t.id),console.log("Generating new reference:",u);let{data:a,error:l}=await r.from("users").insert({reference_code:u,email:i||null,phone:o||null,full_name:n,country:s,stripe_customer_id:t.customer}).select("id").single();if(l)throw console.error("âŒ Failed to create user:",l),l;e=a.id,console.log("ðŸ‘¤ Created new user:",e)}let{error:p}=await r.from("subscriptions").insert({user_id:e,plan:a,status:"active",stripe_session_id:t.id,amount:S[a]||0,card_brand:c,card_last4:d,expires_at:a.includes("annual")?new Date(Date.now()+31536e6).toISOString():new Date(Date.now()+2592e6).toISOString()});p?console.error("âŒ Failed to create subscription:",p):console.log("âœ… Subscription saved to database")}catch(e){console.error("âŒ Database error:",e)}if(t.invoice)try{let r="string"==typeof t.invoice?t.invoice:t.invoice.id;e=(await E.invoices.retrieve(r)).invoice_pdf||void 0}catch(e){console.error("Failed to retrieve invoice for session:",e)}if(a.includes("sms")){if(o){console.log(`ðŸ“± Sending SMS confirmation to ${o}...`);let e=await (0,w.sendSMSConfirmation)(o,a,u);e.success?console.log("âœ… SMS confirmation sent successfully"):console.error("âŒ SMS confirmation failed:",e.error)}if(i){console.log(`ðŸ“§ Sending Email confirmation to ${i}...`);let t=await (0,w.sendEmailConfirmation)(i,a,u,e);t.success?console.log("âœ… Email confirmation sent successfully"):console.error("âŒ Email confirmation failed:",t.error)}}if(a.includes("email")&&i){console.log(`ðŸ“§ Sending Email confirmation to ${i}...`);let t=await (0,w.sendEmailConfirmation)(i,a,u,e);t.success?console.log("âœ… Email confirmation sent successfully"):console.error("âŒ Email confirmation failed:",t.error)}break}case"customer.subscription.updated":{let t=r.data.object;console.log("ðŸ“ Subscription updated:",t.id),console.log("Status:",t.status);try{let a=(0,R.createSupabaseAdmin)();await a.from("subscriptions").update({status:"active"===t.status?"active":"cancelled"}).eq("stripe_subscription_id",t.id);let o=r.data.previous_attributes;if(o&&o.items&&"active"===t.status){console.log("ðŸ”„ Plan change detected");let r=t.items.data[0].price.unit_amount;if(r){let o=(e=>{for(let[t,r]of Object.entries(S))if(r===e)return t;return null})(r);if(o){let{data:r}=await a.from("subscriptions").select("user_id").eq("stripe_subscription_id",t.id).single();if(r?.user_id){let{data:t}=await a.from("users").select("email").eq("id",r.user_id).single();if(t?.email){console.log(`ðŸ“§ Sending plan change email to ${t.email}`);let{sendPlanChangeEmail:r}=await e.A(50950);await r(t.email,o)}}}}}}catch(e){console.error("Failed to update subscription in DB:",e)}break}case"customer.subscription.deleted":{let e=r.data.object;console.log("âŒ Subscription cancelled:",e.id);try{let t=(0,R.createSupabaseAdmin)();await t.from("subscriptions").update({status:"cancelled"}).eq("stripe_subscription_id",e.id)}catch(e){console.error("Failed to cancel subscription in DB:",e)}break}case"invoice.payment_failed":console.log("âš ï¸ Payment failed for invoice:",r.data.object.id);break;case"invoice.payment_succeeded":{let t=r.data.object;if(console.log("ðŸ’° Invoice payment succeeded:",t.id),t.invoice_pdf&&t.customer_email)try{let r=(0,R.createSupabaseAdmin)(),{data:a}=await r.from("users").select("id").or(`stripe_customer_id.eq.${t.customer},email.eq.${t.customer_email}`).single();if(a)if(await r.from("invoices").insert({user_id:a.id,stripe_invoice_id:t.id,amount:t.amount_paid,status:"paid",invoice_pdf:t.invoice_pdf,invoice_number:t.number,created_at:new Date(1e3*t.created).toISOString()}),"subscription_create"!==t.billing_reason){let{sendInvoiceEmail:r}=await e.A(50950);await r(t.customer_email,`${(t.amount_paid/100).toFixed(2)}â‚¬`,t.invoice_pdf,t.number||t.id),console.log("âœ… Invoice email sent")}else console.log("â­ï¸ Skipped invoice email (handled by checkout session)")}catch(e){console.error("Failed to process invoice:",e)}break}case"payment_method.attached":console.log("ðŸ’³ Payment method attached:",r.data.object.id);break;case"payment_method.detached":console.log("ðŸ—‘ï¸ Payment method detached:",r.data.object.id);break;default:console.log(`Unhandled event type: ${r.type}`)}return x.NextResponse.json({received:!0})}e.s(["POST",()=>C],1525);var k=e.i(1525);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/design-update/TypeScript/weather10/app/api/webhooks/stripe/route.ts",nextConfigOutput:"standalone",userland:k}),{workAsyncStorage:q,workUnitAsyncStorage:P,serverHooks:T}=A;function O(){return(0,a.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:P})}async function j(e,t,a){A.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/webhooks/stripe/route";x=x.replace(/\/index$/,"")||"/";let _=await A.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!_)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:R,nextConfig:E,parsedUrl:y,isDraftMode:S,prerenderManifest:C,routerServerContext:k,isOnDemandRevalidate:q,revalidateOnlyGenerated:P,resolvedPathname:T,clientReferenceManifest:O,serverActionsManifest:j}=_,M=(0,l.normalizeAppPath)(x),N=!!(C.dynamicRoutes[M]||C.routes[T]),I=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,y,!1):t.end("This page could not be found"),null);if(N&&!S){let e=!!C.routes[T],t=C.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await I();throw new v.NoFallbackError}}let D=null;!N||A.isDev||S||(D="/index"===(D=T)?"/":D);let $=!0===A.isDev||!N,H=N&&!$;j&&O&&(0,n.setReferenceManifestsSingleton)({page:x,clientReferenceManifest:O,serverActionsManifest:j,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:j})});let U=e.method||"GET",F=(0,i.getTracer)(),K=F.getActiveScopeSpan(),B={params:R,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>A.onRequestError(e,t,a,k)},sharedContext:{buildId:w}},W=new c.NodeNextRequest(e),L=new c.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(W,(0,d.signalFromNodeResponse)(t));try{let n=async e=>A.handle(V,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${x}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var i,l;let c=async({previousCacheEntry:r})=>{try{if(!s&&q&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=B.renderOpts.collectedTags;if(!N)return await (0,m.sendResponse)(W,L,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:q})},k),t}},d=await A.handleResponse({req:e,nextConfig:E,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:q,revalidateOnlyGenerated:P,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:s});if(!N)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",q?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&N||u.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(W,L,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};K?await l(K):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${x}`,kind:i.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:q})}),N)throw t;return await (0,m.sendResponse)(W,L,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>O,"routeModule",()=>A,"serverHooks",()=>T,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>P],95199)},50950,e=>{e.v(e=>Promise.resolve().then(()=>e(75741)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__d8af6fef._.js.map